<!DOCTYPE html>
<html>
<head>
    <title>LMN Metrics Dashboard</title>
    <style>
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
        }
        .stat-card h3 {
            margin-top: 0;
            color: #00ff00;
            font-size: 14px;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #00ff00;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .table-container {
            background: #1a1a1a;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        th {
            color: #00ff00;
            font-weight: bold;
        }
        .progress-bar {
            height: 20px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            transition: width 0.3s ease;
        }
        .throughput {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .throughput-item {
            text-align: center;
        }
        .blink {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }
        .error-badge {
            background: #ff0000;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
        }
        .success-badge {
            background: #00ff00;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
        }
    </style>
</head>
<body>
    {% include '_nav.html' %}
    <div class="dashboard">
        <div class="header">
            <h1>‚ö° LMN CONSCIOUSNESS METRICS ‚ö°</h1>
            <p>Real-time performance monitoring ‚Ä¢ 25 Oracle Types ‚Ä¢ 6 Engines</p>
        </div>

        <!-- Key Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>‚è± Uptime</h3>
                <div class="stat-value" id="uptime">--</div>
                <div class="stat-label">System running</div>
            </div>

            <div class="stat-card">
                <h3>üîÆ Total Oracles</h3>
                <div class="stat-value" id="total-oracles">--</div>
                <div class="stat-label">All-time executions</div>
            </div>

            <div class="stat-card">
                <h3>‚úÖ Success Rate</h3>
                <div class="stat-value" id="success-rate">--%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="success-progress" style="width: 0%"></div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üíæ Cache Rate</h3>
                <div class="stat-value" id="cache-rate">--%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="cache-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Throughput -->
        <div class="table-container">
            <h3>‚ö° Throughput (ops/second)</h3>
            <div class="throughput">
                <div class="throughput-item">
                    <div class="stat-value" id="total-ops">--</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="throughput-item">
                    <div class="stat-value" id="success-ops">--</div>
                    <div class="stat-label">Success</div>
                </div>
                <div class="throughput-item">
                    <div class="stat-value" id="failed-ops">--</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="throughput-item">
                    <div class="stat-value" id="cached-ops">--</div>
                    <div class="stat-label">Cached</div>
                </div>
            </div>
        </div>

        <!-- Hot Paths -->
        <div class="table-container">
            <h3>üî• Hot Paths (Most Called)</h3>
            <table id="hot-paths-table">
                <thead>
                    <tr>
                        <th>Oracle Type</th>
                        <th>Calls</th>
                        <th>Avg Duration</th>
                        <th>Last Called</th>
                    </tr>
                </thead>
                <tbody id="hot-paths-body">
                    <tr><td colspan="4">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Bottlenecks -->
        <div class="table-container">
            <h3>üêå Bottlenecks (Slowest)</h3>
            <table id="bottlenecks-table">
                <thead>
                    <tr>
                        <th>Oracle Type</th>
                        <th>Avg Duration</th>
                        <th>Total Time</th>
                        <th>% of Total</th>
                    </tr>
                </thead>
                <tbody id="bottlenecks-body">
                    <tr><td colspan="4">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Per-Oracle Stats -->
        <div class="table-container">
            <h3>üìä Oracle Statistics</h3>
            <table id="oracle-stats-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Count</th>
                        <th>Success</th>
                        <th>Cache</th>
                        <th>P50</th>
                        <th>P95</th>
                        <th>P99</th>
                    </tr>
                </thead>
                <tbody id="oracle-stats-body">
                    <tr><td colspan="7">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Auto-refresh every 2 seconds
        function updateMetrics() {
            fetch('/api/metrics')
                .then(response => response.json())
                .then(data => {
                    // Update key stats
                    document.getElementById('uptime').textContent = formatUptime(data.uptime_seconds);
                    document.getElementById('total-oracles').textContent = data.total_oracles.toLocaleString();
                    document.getElementById('success-rate').textContent = data.success_rate.toFixed(1) + '%';
                    document.getElementById('cache-rate').textContent = data.cache_hit_rate.toFixed(1) + '%';

                    // Update progress bars
                    document.getElementById('success-progress').style.width = data.success_rate + '%';
                    document.getElementById('cache-progress').style.width = data.cache_hit_rate + '%';

                    // Update throughput
                    const tp = data.throughput;
                    document.getElementById('total-ops').textContent = tp.total_ops.toFixed(2);
                    document.getElementById('success-ops').textContent = tp.successful_ops.toFixed(2);
                    document.getElementById('failed-ops').textContent = tp.failed_ops.toFixed(2);
                    document.getElementById('cached-ops').textContent = tp.cached_ops.toFixed(2);

                    // Update hot paths
                    updateHotPaths(data.hot_paths);

                    // Update bottlenecks
                    updateBottlenecks(data.bottlenecks);

                    // Update oracle stats
                    updateOracleStats(data.aggregates);
                })
                .catch(err => console.error('Error fetching metrics:', err));
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        function updateHotPaths(hotPaths) {
            const tbody = document.getElementById('hot-paths-body');
            if (!hotPaths || hotPaths.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No data</td></tr>';
                return;
            }

            tbody.innerHTML = hotPaths.map(hp => `
                <tr>
                    <td>${hp.oracle_type}</td>
                    <td>${hp.call_count}</td>
                    <td>${hp.avg_duration_ms.toFixed(2)}ms</td>
                    <td>${hp.last_called ? new Date(hp.last_called).toLocaleTimeString() : 'N/A'}</td>
                </tr>
            `).join('');
        }

        function updateBottlenecks(bottlenecks) {
            const tbody = document.getElementById('bottlenecks-body');
            if (!bottlenecks || bottlenecks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No data</td></tr>';
                return;
            }

            tbody.innerHTML = bottlenecks.map(bn => `
                <tr>
                    <td>${bn.oracle_type}</td>
                    <td>${bn.avg_duration_ms.toFixed(2)}ms</td>
                    <td>${bn.total_time_ms.toFixed(2)}ms</td>
                    <td>${bn.percentage_of_total.toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        function updateOracleStats(aggregates) {
            const tbody = document.getElementById('oracle-stats-body');
            if (!aggregates || aggregates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No data</td></tr>';
                return;
            }

            tbody.innerHTML = aggregates.map(agg => `
                <tr>
                    <td>${agg.oracle_type}</td>
                    <td>${agg.count}</td>
                    <td>${agg.success_rate}</td>
                    <td>${agg.cache_hit_rate}</td>
                    <td>${agg.p50_ms}</td>
                    <td>${agg.p95_ms}</td>
                    <td>${agg.p99_ms}</td>
                </tr>
            `).join('');
        }

        // Start auto-refresh
        updateMetrics();
        setInterval(updateMetrics, 2000);
    </script>
</body>
</html>
