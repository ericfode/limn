# Limn Package Management System (LPMS)
## IPFS-Based Decentralized Package Distribution

**Status:** Implemented (v0.2.0)
**Author:** Claude
**Date:** 2026-01-25

---

## 1. Overview

LPMS (Limn Package Management System) uses IPFS for decentralized, content-addressed package distribution. Every package version is immutable and identified by its content hash (CID).

### Key Principles

1. **Content Addressing**: Packages are addressed by CID (Content Identifier)
2. **Immutability**: A CID always refers to the exact same content
3. **Decentralization**: No central server required (anyone can host)
4. **Reproducibility**: Same CID = same package forever
5. **Limn Native**: Uses Limn vocabulary throughout
6. **Security**: Optional package signing with Ed25519 keys

---

## 2. Quick Start

### Creating a Package

```bash
# Initialize a new package
limn pak init my-package
cd my-package

# Edit src/main.limn with your constraints
# Edit pak.limn to update metadata

# Validate the package
limn pak check

# Publish to IPFS
limn pak pub
# Output: Published: my-package@1.0.0
#         CID: bafybeiabc123...
```

### Using a Package

```limn
# Import by CID (exact version)
use cid bafybeiabc123xyz

# Import by name (from registry)
use nom "math-utils"

# Import specific version
use nom "math-utils" ver 1 2 0

# Your constraints using imported definitions...
whe result
math_add cau 5 3 eff result

---
# key
```

### Installing Dependencies

```bash
# Install all dependencies listed in pak.limn
limn pak install

# Add a new dependency
limn pak add math-utils

# Show dependency tree
limn pak tree
```

---

## 3. Package Structure

### Directory Layout

```
my-package/
├── pak.limn          # Package manifest
├── pak.lock.limn     # Lock file (generated)
├── src/
│   ├── main.limn     # Main entry point
│   └── lib/
│       └── utils.limn
├── test/
│   └── test_main.limn
├── .limn_deps/       # Installed dependencies (generated)
├── .limn-pkg/        # Build output (generated)
└── README.md
```

### Package Manifest (pak.limn)

```limn
# pak.limn - Package manifest

# Package info
whe pak_nom
whe pak_ver_maj
whe pak_ver_min
whe pak_ver_pat
whe pak_aut
whe pak_des
whe pak_ent

# Dependencies
whe dep_math_utils
whe dep_io_lib

---
pak_nom sa "my-package"
pak_ver_maj sa 1
pak_ver_min sa 0
pak_ver_pat sa 0
pak_aut sa "alice"
pak_des sa "My awesome Limn package"
pak_ent sa "src/main.limn"

# Dependencies
dep_math_utils sa "^1.0.0"
dep_io_lib sa cid "bafybei..."
```

### Lock File (pak.lock.limn)

Generated by `limn pak install`. Ensures reproducible builds.

```limn
# pak.lock.limn - Resolved dependencies
# Generated by limn pak install
# DO NOT EDIT MANUALLY

whe dep_math_utils_ver
whe dep_math_utils_cid
whe dep_math_utils_int

---
# Resolved versions

dep_math_utils_ver sa "1.2.0"
dep_math_utils_cid sa "bafybeiabc123..."
dep_math_utils_int sa "sha256-abc123..."
```

---

## 4. Import System

### Import Syntax

```limn
# Import by CID (exact version, no registry needed)
use cid bafybeiabc123xyz

# Import by name (requires registry, gets latest)
use nom "math-utils"

# Import by name and version
use nom "math-utils" ver 1 2 0

# Import with alias
use nom "math-utils" as m

# Selective imports
use cid bafybeiabc123xyz | get add | get mul
```

### How Imports Work

1. Parse `use` statement to determine import type
2. Resolve CID (directly or via registry lookup)
3. Check local cache (`~/.limn/pak/<cid>/`)
4. If not cached, fetch from IPFS
5. Parse package manifest to find entry file
6. Extract exports from entry file
7. Inline exported definitions into current program
8. Apply namespace prefix if needed

---

## 5. Registry System

### Decentralized Registry

The registry is stored on IPFS with IPNS providing a mutable pointer.

```json
{
  "version": 1,
  "updated": "2026-01-25T12:00:00Z",
  "packages": {
    "math-utils": {
      "latest": "1.2.0",
      "author": "alice",
      "description": "Mathematical utilities for Limn",
      "versions": {
        "1.0.0": {"cid": "bafybei...", "published": "..."},
        "1.2.0": {"cid": "bafybei...", "published": "..."}
      }
    }
  }
}
```

### Registry Commands

```bash
# Initialize a new registry
limn pak registry init

# Add package to local registry
limn pak registry add my-package 1.0.0 bafybei...

# Publish registry to IPNS
limn pak registry publish --key my-registry

# Search registry
limn pak search "math"

# Get package info
limn pak info math-utils
```

### Multiple Registries

```bash
# Configure default registry
limn pak config set registry ipns://my-registry

# Import from specific registry
use nom "math-utils" from "ipns://custom-registry"
```

---

## 6. Dependency Resolution

### Semver Constraints

```
^1.2.3    >=1.2.3 <2.0.0  (caret - compatible)
~1.2.3    >=1.2.3 <1.3.0  (tilde - patch-level)
>=1.0.0   Greater than or equal
<2.0.0    Less than
=1.2.3    Exact version
*         Any version
```

### Resolution Algorithm

1. Read `pak.limn` dependencies
2. For each dependency:
   - If CID: use directly
   - If constraint: lookup in registry, find matching version
3. Recursively resolve transitive dependencies
4. Detect version conflicts
5. Generate `pak.lock.limn`
6. Fetch packages to cache

### Conflict Detection

```
Warning: math-utils@1.0.0 doesn't satisfy ^1.2.0 (required by other-pkg)

Resolution strategies:
1. Update constraint to compatible range
2. Use specific CID to bypass version
3. Contact package authors
```

---

## 7. Security

### Package Signing

Sign packages with Ed25519 keys for verification.

```bash
# Generate a signing key
limn pak key gen my-key
# Output: Generated key: my-key
#         Fingerprint: abc123...

# Sign a package
limn pak sign . my-key
# Creates pak.sig.limn

# Publish with signature
limn pak pub --sign my-key
```

### Signature File (pak.sig.limn)

```limn
# pak.sig.limn - Package signature

whe sig_pkg_hash
whe sig_signature
whe sig_signer
whe sig_timestamp
whe sig_algorithm

---
sig_pkg_hash sa "sha256-abc123..."
sig_signature sa "base64-signature..."
sig_signer sa "abc123"
sig_timestamp sa "2026-01-25T12:00:00Z"
sig_algorithm sa "ed25519"
```

### Verification

```bash
# Verify package signature
limn pak verify .
# Output: ✓ Valid signature by alice (abc123)

# Or: ✗ Invalid signature
# Or: ✗ Unknown signer: xyz789
```

### Trusted Publishers

```bash
# Add a trusted publisher
limn pak trust add alice alice.pub

# List trusted publishers
limn pak trust list

# Remove trusted publisher
limn pak trust remove abc123
```

---

## 8. Remote Pinning

Keep packages available via pinning services.

### Supported Services

- **Pinata** - Managed IPFS pinning
- **web3.storage** - Free decentralized storage
- **IPFS Pinning Service API** - Generic PSA support

### Configuration

```bash
# Add Pinata service
limn pak pin service add pinata pinata https://api.pinata.cloud <key> <secret>

# Add web3.storage
limn pak pin service add w3s web3.storage https://api.web3.storage <token>

# List services
limn pak pin service list
```

### Pinning

```bash
# Pin published package
limn pak pin bafybei... --name "my-package@1.0.0"

# Pin during publish
limn pak pub --pin pinata

# Check pin status
limn pak pin status bafybei...
```

---

## 9. Caching

### Local Cache Structure

```
~/.limn/
├── pak/                    # Package cache (by CID)
│   ├── bafybei123.../
│   │   ├── pak.limn
│   │   └── src/
│   └── bafybei456.../
├── registry/               # Registry cache
├── keys/                   # Signing keys
│   ├── my-key.key         # Private key
│   └── my-key.pub         # Public key
├── trusted_publishers.json
├── pinning.json            # Pinning service config
└── config.json             # Global config
```

### Cache Commands

```bash
# Show cache info
limn pak cache info

# Clear cache
limn pak cache clear

# Garbage collect unused packages
limn pak cache gc
```

---

## 10. CLI Reference

### Package Lifecycle

| Command | Description |
|---------|-------------|
| `limn pak init <name>` | Create new package |
| `limn pak check [dir]` | Validate structure |
| `limn pak build [dir]` | Build for distribution |
| `limn pak pub [dir]` | Publish to IPFS |

### Dependency Management

| Command | Description |
|---------|-------------|
| `limn pak install [dir]` | Install dependencies |
| `limn pak add <pkg>` | Add dependency |
| `limn pak remove <pkg>` | Remove dependency |
| `limn pak tree [dir]` | Show dependency tree |

### Discovery

| Command | Description |
|---------|-------------|
| `limn pak search <query>` | Search registry |
| `limn pak info [pkg]` | Show package info |

### Security

| Command | Description |
|---------|-------------|
| `limn pak sign <dir> <key>` | Sign package |
| `limn pak verify <dir>` | Verify signature |
| `limn pak key gen <name>` | Generate key |
| `limn pak key list` | List keys |
| `limn pak trust add` | Add trusted publisher |

### Infrastructure

| Command | Description |
|---------|-------------|
| `limn pak registry init` | Create registry |
| `limn pak registry publish` | Publish registry |
| `limn pak pin <cid>` | Pin to service |
| `limn pak cache info` | Cache statistics |

---

## 11. Best Practices

### Versioning

- Use semantic versioning (major.minor.patch)
- Bump major for breaking changes
- Bump minor for new features
- Bump patch for bug fixes

### Publishing

1. Update version in `pak.limn`
2. Run `limn pak check` to validate
3. Sign with `limn pak sign . my-key`
4. Publish with `limn pak pub --pin pinata`
5. Update registry if maintaining one

### Dependencies

- Prefer version constraints over CIDs for flexibility
- Use CIDs for immutable/critical dependencies
- Keep lock file in version control
- Regularly update dependencies

### Security

- Generate and protect your signing key
- Sign all published packages
- Verify packages before use
- Add trusted publisher keys

---

## 12. Limn Vocabulary Extensions

New words for package management:

| Word | Meaning | Example |
|------|---------|---------|
| `pak` | package | `pak nom sa "foo"` |
| `use` | import | `use cid bafybei...` |
| `pub` | publish | `limn pak pub` |
| `dep` | dependency | `whe dep_math` |
| `ver` | version | `ver 1 0 0` |
| `cid` | content ID | `cid bafybei...` |
| `nom` | name | `pak nom sa "foo"` |
| `ent` | entry | `pak ent sa "main.limn"` |
| `sig` | signature | `sig_signer` |

---

## 13. Troubleshooting

### IPFS not available

```
Error: IPFS daemon not running
Start with: ipfs daemon
```

Install IPFS from https://ipfs.tech/ and run `ipfs daemon`.

### Package not found

```
Package not found: math-utils (^1.0.0)
```

Options:
- Check package name spelling
- Use direct CID if registry unavailable
- Check registry configuration

### Signature verification failed

```
✗ Unknown signer: xyz789
```

Add the signer to trusted publishers:
```bash
limn pak trust add author author.pub
```

---

## 14. Architecture

```
┌─────────────────────────────────────────────────────────┐
│                     limn pak CLI                        │
├─────────────────────────────────────────────────────────┤
│  limn_pak_cli.py - Unified interface                    │
├─────────┬─────────┬─────────┬─────────┬────────────────┤
│Registry │Resolver │ Import  │Security │   Pinning      │
│         │         │ System  │         │                │
│ lookup  │ semver  │ use     │ sign    │ pinata         │
│ search  │ lock    │ export  │ verify  │ web3.storage   │
│ publish │ graph   │ inline  │ trust   │ generic PSA    │
├─────────┴─────────┴─────────┴─────────┴────────────────┤
│                        IPFS                             │
│  Content addressing • DHT • Pubsub • IPNS              │
└─────────────────────────────────────────────────────────┘
```

---

## 15. Future Roadmap

- [ ] Workspace/monorepo support
- [ ] Private packages (encrypted)
- [ ] Package analytics
- [ ] Automated security scanning
- [ ] IDE integration
- [ ] Web-based registry browser

---

**END OF SPECIFICATION**
